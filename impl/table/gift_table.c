#include "gift_table.h"

#include <stdlib.h>
#include <string.h>

static const int round_const[] = {
        // rounds 0-15
        0x01, 0x03, 0x07, 0x0F, 0x1F, 0x3E, 0x3D, 0x3B,
        0x37, 0x2F, 0x1E, 0x3C, 0x39, 0x33, 0x27, 0x0E,
        // rounds 16-31
        0x1D, 0x3A, 0x35, 0x2B, 0x16, 0x2C, 0x18, 0x30,
        0x21, 0x02, 0x05, 0x0B, 0x17, 0x2E, 0x1C, 0x38,
        // rounds 32-47
        0x31, 0x23, 0x06, 0x0D, 0x1B, 0x36, 0x2D, 0x1A,
        0x34, 0x29, 0x12, 0x24, 0x08, 0x11, 0x22, 0x04
};

static const uint64_t tables[16][16] = {
        { 0x0000000000000001UL, 0x0008000000020000UL, 0x0000000400000000UL, 0x0008000400000000UL, 0x0000000400020000UL, 0x0008000400020001UL, 0x0000000000020001UL, 0x0008000000000001UL, 0x0000000000020000UL, 0x0008000400000001UL, 0x0008000000020001UL, 0x0000000400020001UL, 0x0000000400000001UL, 0x0000000000000000UL, 0x0008000000000000UL, 0x0008000400020000UL },
        { 0x0001000000000000UL, 0x0000000800000002UL, 0x0000000000040000UL, 0x0000000800040000UL, 0x0000000000040002UL, 0x0001000800040002UL, 0x0001000000000002UL, 0x0001000800000000UL, 0x0000000000000002UL, 0x0001000800040000UL, 0x0001000800000002UL, 0x0001000000040002UL, 0x0001000000040000UL, 0x0000000000000000UL, 0x0000000800000000UL, 0x0000000800040002UL },
        { 0x0000000100000000UL, 0x0002000000080000UL, 0x0000000000000004UL, 0x0000000000080004UL, 0x0002000000000004UL, 0x0002000100080004UL, 0x0002000100000000UL, 0x0000000100080000UL, 0x0002000000000000UL, 0x0000000100080004UL, 0x0002000100080000UL, 0x0002000100000004UL, 0x0000000100000004UL, 0x0000000000000000UL, 0x0000000000080000UL, 0x0002000000080004UL },
        { 0x0000000000010000UL, 0x0000000200000008UL, 0x0004000000000000UL, 0x0004000000000008UL, 0x0004000200000000UL, 0x0004000200010008UL, 0x0000000200010000UL, 0x0000000000010008UL, 0x0000000200000000UL, 0x0004000000010008UL, 0x0000000200010008UL, 0x0004000200010000UL, 0x0004000000010000UL, 0x0000000000000000UL, 0x0000000000000008UL, 0x0004000200000008UL },
        { 0x0000000000000010UL, 0x0080000000200000UL, 0x0000004000000000UL, 0x0080004000000000UL, 0x0000004000200000UL, 0x0080004000200010UL, 0x0000000000200010UL, 0x0080000000000010UL, 0x0000000000200000UL, 0x0080004000000010UL, 0x0080000000200010UL, 0x0000004000200010UL, 0x0000004000000010UL, 0x0000000000000000UL, 0x0080000000000000UL, 0x0080004000200000UL },
        { 0x0010000000000000UL, 0x0000008000000020UL, 0x0000000000400000UL, 0x0000008000400000UL, 0x0000000000400020UL, 0x0010008000400020UL, 0x0010000000000020UL, 0x0010008000000000UL, 0x0000000000000020UL, 0x0010008000400000UL, 0x0010008000000020UL, 0x0010000000400020UL, 0x0010000000400000UL, 0x0000000000000000UL, 0x0000008000000000UL, 0x0000008000400020UL },
        { 0x0000001000000000UL, 0x0020000000800000UL, 0x0000000000000040UL, 0x0000000000800040UL, 0x0020000000000040UL, 0x0020001000800040UL, 0x0020001000000000UL, 0x0000001000800000UL, 0x0020000000000000UL, 0x0000001000800040UL, 0x0020001000800000UL, 0x0020001000000040UL, 0x0000001000000040UL, 0x0000000000000000UL, 0x0000000000800000UL, 0x0020000000800040UL },
        { 0x0000000000100000UL, 0x0000002000000080UL, 0x0040000000000000UL, 0x0040000000000080UL, 0x0040002000000000UL, 0x0040002000100080UL, 0x0000002000100000UL, 0x0000000000100080UL, 0x0000002000000000UL, 0x0040000000100080UL, 0x0000002000100080UL, 0x0040002000100000UL, 0x0040000000100000UL, 0x0000000000000000UL, 0x0000000000000080UL, 0x0040002000000080UL },
        { 0x0000000000000100UL, 0x0800000002000000UL, 0x0000040000000000UL, 0x0800040000000000UL, 0x0000040002000000UL, 0x0800040002000100UL, 0x0000000002000100UL, 0x0800000000000100UL, 0x0000000002000000UL, 0x0800040000000100UL, 0x0800000002000100UL, 0x0000040002000100UL, 0x0000040000000100UL, 0x0000000000000000UL, 0x0800000000000000UL, 0x0800040002000000UL },
        { 0x0100000000000000UL, 0x0000080000000200UL, 0x0000000004000000UL, 0x0000080004000000UL, 0x0000000004000200UL, 0x0100080004000200UL, 0x0100000000000200UL, 0x0100080000000000UL, 0x0000000000000200UL, 0x0100080004000000UL, 0x0100080000000200UL, 0x0100000004000200UL, 0x0100000004000000UL, 0x0000000000000000UL, 0x0000080000000000UL, 0x0000080004000200UL },
        { 0x0000010000000000UL, 0x0200000008000000UL, 0x0000000000000400UL, 0x0000000008000400UL, 0x0200000000000400UL, 0x0200010008000400UL, 0x0200010000000000UL, 0x0000010008000000UL, 0x0200000000000000UL, 0x0000010008000400UL, 0x0200010008000000UL, 0x0200010000000400UL, 0x0000010000000400UL, 0x0000000000000000UL, 0x0000000008000000UL, 0x0200000008000400UL },
        { 0x0000000001000000UL, 0x0000020000000800UL, 0x0400000000000000UL, 0x0400000000000800UL, 0x0400020000000000UL, 0x0400020001000800UL, 0x0000020001000000UL, 0x0000000001000800UL, 0x0000020000000000UL, 0x0400000001000800UL, 0x0000020001000800UL, 0x0400020001000000UL, 0x0400000001000000UL, 0x0000000000000000UL, 0x0000000000000800UL, 0x0400020000000800UL },
        { 0x0000000000001000UL, 0x8000000020000000UL, 0x0000400000000000UL, 0x8000400000000000UL, 0x0000400020000000UL, 0x8000400020001000UL, 0x0000000020001000UL, 0x8000000000001000UL, 0x0000000020000000UL, 0x8000400000001000UL, 0x8000000020001000UL, 0x0000400020001000UL, 0x0000400000001000UL, 0x0000000000000000UL, 0x8000000000000000UL, 0x8000400020000000UL },
        { 0x1000000000000000UL, 0x0000800000002000UL, 0x0000000040000000UL, 0x0000800040000000UL, 0x0000000040002000UL, 0x1000800040002000UL, 0x1000000000002000UL, 0x1000800000000000UL, 0x0000000000002000UL, 0x1000800040000000UL, 0x1000800000002000UL, 0x1000000040002000UL, 0x1000000040000000UL, 0x0000000000000000UL, 0x0000800000000000UL, 0x0000800040002000UL },
        { 0x0000100000000000UL, 0x2000000080000000UL, 0x0000000000004000UL, 0x0000000080004000UL, 0x2000000000004000UL, 0x2000100080004000UL, 0x2000100000000000UL, 0x0000100080000000UL, 0x2000000000000000UL, 0x0000100080004000UL, 0x2000100080000000UL, 0x2000100000004000UL, 0x0000100000004000UL, 0x0000000000000000UL, 0x0000000080000000UL, 0x2000000080004000UL },
        { 0x0000000010000000UL, 0x0000200000008000UL, 0x4000000000000000UL, 0x4000000000008000UL, 0x4000200000000000UL, 0x4000200010008000UL, 0x0000200010000000UL, 0x0000000010008000UL, 0x0000200000000000UL, 0x4000000010008000UL, 0x0000200010008000UL, 0x4000200010000000UL, 0x4000000010000000UL, 0x0000000000000000UL, 0x0000000000008000UL, 0x4000200000008000UL }
};

void gift_64_table_generate_round_keys(uint64_t rks[restrict ROUNDS_GIFT_64],
                                       const uint64_t key[restrict 2])
{
        uint64_t key_state[] = {key[0], key[1]};
        for (int round = 0; round < ROUNDS_GIFT_64; round++) {
                int v = (key_state[0] >> 0 ) & 0xffff;
                int u = (key_state[0] >> 16) & 0xffff;

                // add round key (RK=U||V)
                rks[round] = 0UL;
                for (size_t i = 0; i < 16; i++) {
                        int key_bit_v   = (v >> i)  & 0x1;
                        int key_bit_u   = (u >> i)  & 0x1;
                        rks[round] ^= (uint64_t)key_bit_v << (i * 4 + 0);
                        rks[round] ^= (uint64_t)key_bit_u << (i * 4 + 1);
                }

                // add single bit
                rks[round] ^= 1UL << 63;

                // add round constants
                rks[round] ^= ((round_const[round] >> 0) & 0x1) << 3;
                rks[round] ^= ((round_const[round] >> 1) & 0x1) << 7;
                rks[round] ^= ((round_const[round] >> 2) & 0x1) << 11;
                rks[round] ^= ((round_const[round] >> 3) & 0x1) << 15;
                rks[round] ^= ((round_const[round] >> 4) & 0x1) << 19;
                rks[round] ^= ((round_const[round] >> 5) & 0x1) << 23;

                // update key state
                int k0 = (key_state[0] >> 0 ) & 0xffffUL;
                int k1 = (key_state[0] >> 16) & 0xffffUL;
                k0 = (k0 >> 12) | ((k0 & 0xfff) << 4);
                k1 = (k1 >> 2 ) | ((k1 & 0x3  ) << 14);
                key_state[0] >>= 32;
                key_state[0] |= (key_state[1] & 0xffffffffUL) << 32;
                key_state[1] >>= 32;
                key_state[1] |= ((uint64_t)k0 << 32) | ((uint64_t)k1 << 48);
        }
}

uint64_t gift_64_table_subperm(const uint64_t cipher_state)
{
        uint64_t new_cipher_state = 0;

        for (size_t i = 0; i < 16; i++) {
                int nibble = (cipher_state >> (i * 4)) & 0xf;
                new_cipher_state ^= tables[i][nibble];
        }

        return new_cipher_state;
}

uint64_t gift_64_table_encrypt(const uint64_t m,
                               const uint64_t rks[restrict ROUNDS_GIFT_64])
{
        uint64_t c = m;

        // round loop
        for (int round = 0; round < ROUNDS_GIFT_64; round++) {
                c = gift_64_table_subperm(c);
                c ^= rks[round];
        }

        return c;
}
